<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Conquista - Elo Digital</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7B2CBF">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log("Elo Digital: Chat Pronto!"))
          .catch((err) => console.log("Erro no Service Worker", err));
      }
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .chat-header { background: white; padding: 20px; text-align: center; border-bottom: 2px solid #7B2CBF; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        
        /* Bal√µes de Mensagem */
        .msg { max-width: 80%; padding: 12px; border-radius: 15px; font-size: 0.9rem; line-height: 1.4; position: relative; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.me { align-self: flex-end; background: #7B2CBF; color: white; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg small { display: block; font-size: 0.6rem; margin-top: 5px; opacity: 0.7; }

        /* Barra de Digita√ß√£o */
        .input-area { background: white; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #eee; padding-bottom: 90px; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 1rem; }
        .btn-send-chat { background: #E63946; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* ESTILOS DO MENU INFERIOR (Essencial para o visual de App) */
        .nav-menu { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-top: 2px solid #7B2CBF; z-index: 1000; padding-bottom: 10px; }
        .nav-item { text-decoration: none; color: #666; display: flex; flex-direction: column; align-items: center; font-size: 1.4rem; }
        .nav-item small { font-size: 0.65rem; font-weight: bold; text-transform: uppercase; margin-top: 4px; }
        .nav-add { background: #E63946; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; box-shadow: 0 4px 10px rgba(230, 57, 70, 0.4); margin-bottom: 20px; border: 4px solid white; }
    </style>
</head>
<body>

    <div class="chat-header">
        <h3 style="margin:0; color: #7B2CBF;">üí¨ Chat de Conquista</h3>
        <small id="status">Conectando...</small>
    </div>

    <div id="chat-window">
        </div>

    <div class="input-area">
        <input type="text" id="msgInput" placeholder="Planeje a conquista...">
        <button class="btn-send-chat" onclick="enviar()">‚ûî</button>
    </div>

    <div class="nav-menu">
        <a href="index.html" class="nav-item">üè†<small>Painel</small></a>
        <a href="biblioteca.html" class="nav-item">üìö<small>Biblioteca</small></a>
        <a href="adicionar.html" class="nav-item"><div class="nav-add">Ôºã</div></a>
        <a href="explorar.html" class="nav-item">üåé<small>Explorar</small></a>
        <a href="chat.html" class="nav-item" style="color: #7B2CBF;">üí¨<small>Chat</small></a>
    </div>

    <script>
        const BASE_URL = "https://thiago19932-elo-digital-33.deno.dev";
        const MEU_EMAIL = localStorage.getItem('usuarioLogado') || "visitante@teste.com";
        const PARA_EMAIL = "geral@teste.com"; 
        const SALA = [MEU_EMAIL, PARA_EMAIL].sort().join("_");

        document.getElementById('status').innerText = `Logado como: ${MEU_EMAIL}`;

        async function enviar() {
            const input = document.getElementById('msgInput');
            const texto = input.value;
            if (!texto) return;

            try {
                await fetch(`${BASE_URL}/mensagens/enviar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ de: MEU_EMAIL, para: PARA_EMAIL, texto })
                });
                input.value = "";
                carregarMensagens();
            } catch (e) { console.error("Erro ao enviar"); }
        }

        async function carregarMensagens() {
            try {
                const res = await fetch(`${BASE_URL}/mensagens/ler/${SALA}`);
                const msgs = await res.json();
                
                const windowChat = document.getElementById('chat-window');
                windowChat.innerHTML = msgs.map(m => `
                    <div class="msg ${m.de === MEU_EMAIL ? 'me' : 'other'}">
                        ${m.texto}
                        <small>${m.data} - ${m.de.split('@')[0]}</small>
                    </div>
                `).join('');
                
                windowChat.scrollTop = windowChat.scrollHeight;
            } catch (e) { console.error("Erro ao carregar"); }
        }

        setInterval(carregarMensagens, 3000);
        carregarMensagens();
    </script>
</body>
</html>